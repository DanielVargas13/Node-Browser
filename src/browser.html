<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="../node_modules/dragula/dist/dragula.css">
        <!--<script src="https://kit.fontawesome.com/3a65bbcb07.js" crossorigin="anonymous" integrity="sha384-G8pbzceOfzKPtdwA6GCLQ7UajjqiiRuwxHH3p+77MQNhFWmQGVLWV5PbqVsctufh"></script>-->
    </head>
    <body style="margin:0">
        <div class="bar-and-tabs">
            <div class="tool-bar">
                <form id="form">             
                    <button id="back"></button> <!--<i class="fas fa-chevron-left"></i>-->
                    <button id="forward"></button> <!--<i class="fas fa-chevron-right"></i>-->
                    <input type="text" id="searchbar" placeholder="Search...">
                    <button id="reload"></button><!--<i class="fas fa-redo-alt"></i>-->
                    <button id="home"></button> <!--<i class="fas fa-home"></i>-->
                    <button id="history"></button>
                </form>
            </div>
        
            <div class="etabs-tabgroup">
                <div class="etabs-tabs"></div>
                <div class="etabs-buttons"></div>
            </div>
        </div>
        <div class="etabs-views"></div>
        <!--script for tabs-->
        <script>
            let settings = require('./json/app/settings.json')
            const TabGroup = require('electron-tabs')
            const dragula = require('dragula')

            let tabGroup = new TabGroup({
                ready: function (Group) {
                    dragula([Group.tabContainer], {
                        direction: "horizontal"
                    })
                    
                },
                newTab: {
                    title: 'New Tab',
                    src: settings.home || settings.searchEngine,
                    active: true
                }
            });

            tabGroup.addTab({
                title: 'Home',
                src: settings.home || settings.searchEngine,
                visible: true,
                active: true,
            })
        </script>

<!--search script-->
<script>
    // Util functions
    let { changeTabInfo, search, tabListeners, shortcuts, addHistoryEntry } = require('./functions/funcs.js')
    // JSON
    let util = require('./json/app/util.json')
    let icons = require('./json/app/icons.json')
    // Modules
    let isOnline = require('is-online')
    let isReachable = require('is-reachable')
    const path = require('path')
    const url = require('url')
    const fs = require('fs')
    
    // HTML Elements
    let searchbar = document.getElementById('searchbar')
    let back = document.getElementById('back')
    let forward = document.getElementById('forward')
    let reload = document.getElementById('reload')
    let home = document.getElementById('home')
    let history = document.getElementById('history')

    let activeTab = tabGroup.getActiveTab() || tabGroup.getTabByPosition(1)

    // Dev stuff
    process.getCPUUsage()

    // Loading default theme
    this.document.head.innerHTML += settings.dark ? `<link rel="stylesheet" href="./dark-style.css">`: `<link rel="stylesheet" href="./style.css">`

    // Testing internet
    async function isConnected() {
        let online = await isOnline()
        if (online) {
            console.log('Client is online.')
            let connected = await isReachable([`https://google.com`, `https://apple.com`, `https://microsoft.com`])
            if (connected) {
                console.log('Client is connected.')
                return true
            }
            else {
                console.log('Client is not connected.')
                activeTab.webview.loadURL(util.notConnected)
                return false
            }
        }
        else {
            console.log('Client is not online.')
            activeTab.webview.loadURL(util.notConnected)
            return false
        }
    }

    isConnected()

    // Loading default button images
    function loadDefaultImages() {
        if (settings.dark) {
            back.innerHTML = `<image src=${icons.dark.back}>`
            forward.innerHTML = `<image src=${icons.dark.forward}>`
            reload.innerHTML = `<image src=${icons.dark.reload}>`
            home.innerHTML = `<image src=${icons.dark.home}>`
            history.innerHTML = `<image src=${icons.dark.history}>`
        } else {
            back.innerHTML = `<image src=${icons.light.back}>`
            forward.innerHTML = `<image src=${icons.light.forward}>`
            reload.innerHTML = `<image src=${icons.light.reload}>`
            home.innerHTML = `<image src=${icons.light.home}>`
            history.innerHTML = `<image src=${icons.light.history}>`
        }    
    }
    loadDefaultImages()
    // Form
    document.getElementById('form').addEventListener("submit", function(e) {
            e.preventDefault()
            search(e)
        }, false)
        
    // Init tab
    tabGroup.getTabByPosition(1).on('webview-ready', (tab) => {
            changeTabInfo(tab, {
                icon: true,
                title: true
            })
            tabListeners(tab),
            addHistoryEntry(tab.webview.getURL(), tab.webview.getTitle(), tab)
        })

    // Tabs
    tabGroup.on('tab-active', (tab) => {
        activeTab = tab
        tab.on('webview-ready', (tab) => {
            console.log('webview is ready')
            let url, title
            if (tab.webview.getURL().endsWith('history.html')) { url = 'Node-Browser/History' }
            else if (tab.webview.getURL().endsWith('error.html')) { url = 'Node-Browser/Error' }
            else if (tab.webview.getURL().endsWith('notConnected.html')) { url = 'Node-Browser/Notconnected' }
            else { url = false; addHistoryEntry(tab.webview.getURL(), title || tab.webview.getTitle(), tab) }

            changeTabInfo(tab, { 
                icon: true,
                title: true,
                url: url
            })
            tabListeners(tab)
        })
    })
    tabGroup.on('tab-removed', (tab) => {
        if (tabGroup.getTabs()[0] == undefined) {
            let home = tabGroup.addTab({
                title: 'Home',
                src: settings.home || settings.searchEngine,
                active: true
            })
            changeTabInfo(home)
            tabListeners(home)
            activeTab = home
        }
    })
    
    
    // Search bar and buttons
    reload.onclick = function() {
        activeTab.webview.reload()
    }
    back.onclick = function() {
        if (activeTab.webview.canGoBack() === true) {
            activeTab.webview.goBack()
        }
    }
    forward.onclick = function() {
        if (activeTab.webview.canGoForward() === true) {
            activeTab.webview.goForward()
        }
    }
    home.onclick = function() {
        activeTab.webview.loadURL(settings.home || settings.searchEngine)
    }
   /* test.onclick = function(e) {
        e.preventDefault()
        let head = e.view.document.head

        if (head.innerHTML.search('<link rel="stylesheet" href="./dark-style.css">') !== -1 || 
            head.innerHTML.search('<link rel="stylesheet" href="./style.css">') !== -1) {
                console.log('found!')
            head.innerHTML.replace(settings.dark ? `<link rel="stylesheet" href="./dark-style.css">`: `<link rel="stylesheet" href="./style.css">`)
            return
        }
       head.innerHTML += settings.dark ? `<link rel="stylesheet" href="./dark-style.css">`: `<link rel="stylesheet" href="./style.css">`
    }*/
    history.onclick = function() {
        let history = tabGroup.addTab({
            title: 'History',
            src: util.history,
            active: true
        })
        changeTabInfo(history, {
            url: `Node-Browser/History`
        })
        tabListeners(history)
    }
</script>
</body>
</html>
